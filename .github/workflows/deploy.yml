name: CI/CD Pipeline - VCHASNO Analytics

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: vchasno-analytics-analyzer
  S3_BUCKET: vchasno-lambda-deployments

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov boto3-stubs
      
      - name: Run unit tests
        run: |
          pytest tests/ --cov=. --cov-report=xml --cov-report=html
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install linters
        run: |
          pip install pylint flake8 black mypy
      
      - name: Run linters
        run: |
          black --check *.py
          flake8 *.py --max-line-length=100
          pylint *.py --disable=C0111
          mypy *.py --ignore-missing-imports

  build:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create deployment package
        run: |
          mkdir -p package
          pip install -r requirements.txt -t package/
          cp lambda_handler.py package/
          cd package && zip -r ../lambda_deployment.zip . && cd ..
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: lambda-package
          path: lambda_deployment.zip
          retention-days: 30

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: development
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: lambda-package
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload to S3
        run: |
          aws s3 cp lambda_deployment.zip s3://${{ env.S3_BUCKET }}/dev/lambda_deployment.zip
      
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}-dev \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --s3-key dev/lambda_deployment.zip
      
      - name: Publish Lambda version
        run: |
          aws lambda publish-version \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}-dev

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: lambda-package
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload to S3
        run: |
          aws s3 cp lambda_deployment.zip s3://${{ env.S3_BUCKET }}/prod/lambda_deployment.zip
      
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --s3-key prod/lambda_deployment.zip
      
      - name: Publish Lambda version
        id: publish
        run: |
          VERSION=$(aws lambda publish-version \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --query 'Version' --output text)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update Lambda alias
        run: |
          aws lambda update-alias \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --name production \
            --function-version ${{ steps.publish.outputs.version }}
      
      - name: Run smoke tests
        run: |
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --payload '{"body": "{\"document_id\": \"test-123\", \"document_type\": \"contract\"}"}' \
            response.json
          cat response.json

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-prod]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'VCHASNO Analytics deployment completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
